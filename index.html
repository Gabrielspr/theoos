<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TheoOS XP (pastel)</title>
  <style>
    :root{
      --xp-blue: #b3d4ff; --xp-green: #c7f4c2; --xp-yellow: #ffe8a3;
      --xp-pink: #ffd3e2; --xp-lilac: #e6d9ff; --xp-sky: #d7f3ff;
      --text: #3a3a3a; --shadow: rgba(0,0,0,.12); --glass: rgba(255,255,255,.65);
      --titlebar: linear-gradient(180deg, #cfe6ff, #b8d8ff);
      --titlebar-focus: linear-gradient(180deg, #ffd6e8, #ffc2dc);
      --taskbar: #cae6ff; --taskbar-line: #b9d7ff;
    }
    *{box-sizing:border-box;font-family: "Trebuchet MS", system-ui, sans-serif}
    body,html{height:100%;margin:0;background:#9ed3ff;overflow:hidden;color:var(--text)}
    
    #pre-boot{ position:fixed; inset:0; background: #000; z-index: 200; display: grid; place-items: center; }
    #initButton{ font-size: 1.2rem; padding: 14px 28px; border-radius: 12px; border: 1px solid #444; background: #222; color: #fff; cursor: pointer; transition: background .2s; }
    #initButton:hover{ background: #333; }
    
    .wallpaper{ position:fixed;inset:0;overflow:hidden; background-size: cover; background-position: center; transition: background-image .5s ease-in-out; }
    .cloud{position:absolute;filter:blur(2px);opacity:.35}
    .cloud::before{content:"";display:block;width:220px;height:90px;border-radius:60px;background:white;box-shadow: 80px -20px 0 10px white, 150px 0 0 0 white, 40px 10px 0 -10px white; }

    #bootScreen{ position:fixed;inset:0;background:black;z-index:100;display:none;place-items:center; }
    #bootVideo{ width:100%;height:100%;object-fit:cover; }

    /* --- ESTILO DA TELA DE LOGIN KAWAII --- */
    #login{
        position:fixed; inset:0; display:none; place-items:center; z-index:5;
        background-image: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        backdrop-filter: blur(10px);
    }
    .login-card {
        width:min(95vw, 380px);
        background: #fff;
        box-shadow: 0 15px 40px rgba(255, 105, 180, 0.2);
        border-radius:24px;
        padding: 30px;
        border: 2px solid var(--xp-pink);
        text-align: center;
    }
    .login-title .logo { font-size: 2.5rem; margin-bottom: 10px; }
    .login-title h1 { font-size: 1.5rem; margin:0; font-weight: 700; color: var(--xp-pink); }
    .login-form { margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
    .login-form input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #eee; text-align: center; font-size: 1rem; }
    .login-form input:focus { outline: none; border-color: var(--xp-pink); box-shadow: 0 0 0 3px rgba(255, 192, 203, 0.5); }
    .btn.btn-login { padding: 14px; font-size: 1.1rem; background: var(--xp-pink); color: #fff; }
    .hint { margin-top: 15px; font-size: 0.8rem; opacity: 0.6; }
    
    #desktop{position:fixed;inset:0;display:none}
    .icons{position:absolute;inset:0; padding:14px; display:grid; grid-template-columns: repeat(auto-fill, 92px); align-content:start; gap:18px}
    .icon{width:86px;display:flex;flex-direction:column;align-items:center;gap:6px;user-select:none;cursor:pointer}
    .icon .badge{font-size:11px;padding:4px 8px;border-radius:9px;background:rgba(255,255,255,.7);box-shadow:0 2px 8px var(--shadow)}
    .icon svg{width:48px;height:48px;filter:drop-shadow(0 4px 6px var(--shadow))}

    .taskbar{position:absolute;left:0;right:0;bottom:0;height:42px;background:var(--taskbar);border-top:1px solid var(--taskbar-line);display:flex;align-items:center;gap:10px;padding:0 8px}
    .start{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:14px;background:white;box-shadow:0 6px 14px var(--shadow);cursor:pointer;font-weight:700}
    
    #mute-btn {
        position: absolute; bottom: 52px; right: 14px; width: 40px; height: 40px;
        border-radius: 50%; border: none; background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(5px); box-shadow: 0 4px 12px var(--shadow); cursor: pointer;
        display: flex; align-items: center; justify-content: center; z-index: 5;
    }
    #mute-btn svg { width: 20px; height: 20px; fill: var(--text); }

    .window{position:absolute;min-width:320px;min-height:220px;background:#fff;border-radius:14px;box-shadow:0 18px 50px var(--shadow);border:1px solid #e9f0ff;overflow:hidden; display:flex; flex-direction:column;}
    .titlebar{height:36px;display:flex;align-items:center;gap:8px;padding:0 10px;background:var(--titlebar);cursor:move;border-bottom:1px solid #d7e7ff; flex-shrink: 0;}
    .window.focus .titlebar{background:var(--titlebar-focus)}
    .titlebar .dots{display:flex;gap:6px;margin-right:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.red{background:#ff8aa0} .dot.yellow{background:#ffd47a} .dot.green{background:#9be69b}
    .win-content{padding:12px; flex-grow:1; overflow:auto; display:flex; flex-direction:column;}
    .win-actions{margin-left:auto;display:flex;gap:6px}
    .win-btn{border:0;background:white;border-radius:8px;padding:4px 8px;cursor:pointer}

    /* --- ESTILOS DOS APPS --- */
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:15px}
    .gallery figure { margin: 0; }
    .gallery img{width:100%;aspect-ratio:1;border-radius:12px;object-fit:cover;box-shadow:0 6px 16px var(--shadow); margin-bottom: 5px;}
    .gallery figcaption { font-size: 0.8rem; text-align: center; }
    .music-player { text-align: center; padding: 10px; }
    #song-title { font-weight: 700; margin-bottom: 15px; }
    .music-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top:10px;}
    .music-controls button { background: none; border: 0; cursor: pointer; padding: 5px; }
    .music-controls svg { width: 32px; height: 32px; fill: var(--text); }
    #play-pause-btn svg { width: 42px; height: 42px; }
    .term{background:#0b1020;color:#e5e7ff;border-radius:10px;padding:10px;font-family:ui-monospace, monospace;height:100%;overflow:auto; flex-grow:1;}
    .term .prompt{color:#a0d6ff}
    .term input{width:100%;background:transparent;border:0;color:#fff;outline:none}
    .achievements{display:grid;gap:10px}
    .ach{display:flex;align-items:center;gap:10px;background:var(--xp-lilac);padding:10px;border-radius:12px}
    #reminder-text { font-size: 1.3rem; text-align: center; margin: auto; padding: 20px; }
    .paint-toolbar { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;}
    .color-palette { display: flex; gap: 6px; }
    .color-box { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 0 0 1px #ccc; }
    .color-box.active { box-shadow: 0 0 0 2px var(--xp-blue); }
    #paint-canvas { flex-grow: 1; border: 1px solid #eee; border-radius: 10px; touch-action: none; }
    .calculator { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; height: 100%; }
    .calc-display { grid-column: 1 / -1; background: #f3f4f6; border-radius: 10px; padding: 10px; text-align: right; font-size: 2rem; }
    .calc-btn { background: var(--xp-sky); border: 0; border-radius: 10px; font-size: 1.2rem; cursor: pointer; }
    .calc-btn.op { background: var(--xp-yellow); }
    .calc-btn.eq { background: var(--xp-pink); grid-column: 3 / -1; }
    .settings-grid { display: grid; gap: 20px; }
    .settings-group h3 { margin-top: 0; margin-bottom: 10px; }
    .settings-group .options { display: flex; gap: 10px; flex-wrap: wrap; }
    .settings-group button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
    .settings-group button.active { background: var(--xp-blue); border-color: var(--xp-blue); }
    .adventure-text { margin: 0 0 20px 0; line-height: 1.6; }
    .adventure-choices { display: flex; flex-direction: column; gap: 10px; margin-top: auto; }
    .adventure-choices button { width: 100%; text-align: left; padding: 12px; }

    .start-menu{position:absolute;left:8px;bottom:46px;width:280px;background:white;border-radius:14px;box-shadow:0 18px 50px var(--shadow);display:none;overflow:hidden}
    .start-list{padding:8px;display:grid;gap:6px}
    .start-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;cursor:pointer}
    .start-item:hover{background:#f6faff}
  </style>
</head>
<body>
  <section id="pre-boot"> <button id="initButton">✨ Inicializar TheoOS ✨</button> </section>
  <section id="bootScreen"> <video id="bootVideo" src="boot.mp4" playsinline></video> </section>
  <div class="wallpaper" id="wallpaper"> <div class="cloud" style="top:12%;left:8%"></div> <div class="cloud" style="top:24%;left:42%;transform:scale(1.2)"></div> <div class="cloud" style="top:54%;left:18%;transform:scale(1.1)"></div> <div class="cloud" style="top:66%;left:68%;transform:scale(0.9)"></div> </div>
  
  <section id="login">
    <div class="login-card">
      <div class="login-title">
        <div class="logo">🌸</div>
        <h1>Bem-vindo ao TheoOS</h1>
      </div>
      <form class="login-form" id="loginForm">
        <input id="user" value="Theo" readonly />
        <input id="pass" type="password" placeholder="senha (dica: theo)" />
        <button class="btn btn-login" type="submit">Entrar no Coração</button>
      </form>
      <div class="hint">Um lugarzinho seguro e fofo só pra você.</div>
    </div>
  </section>

  <section id="desktop">
    <div class="icons">
      </div>
    <button id="mute-btn" title="Parar/Tocar música de fundo"></button>

    <div class="taskbar"> <div class="start" id="startBtn"> <svg viewBox="0 0 24 24" fill="none"><path d="M4 12a8 8 0 1016 0A8 8 0 004 12zm4.5-1.5l7 3.5-7 3.5v-7z" fill="#ff80a8"/></svg> Iniciar ♡ </div> <div class="tray" style="margin-left:auto;"> <div id="clock" style="background:white;border-radius:10px;padding:6px 10px;box-shadow:0 6px 14px var(--shadow)">--:--</div> </div> </div>
    <div class="start-menu" id="startMenu"> <div class="start-list"></div> </div>

    <div class="window" id="win-notes" style="width:420px;height:360px;display:none">
        <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">Minhas Cartas</div><div class="win-actions"><button class="win-btn" data-close>X</button></div></div>
        <div class="win-content">
            <p>Escreva aqui suas cartas. 💌</p>
            <textarea id="notesArea" style="flex-grow:1;border:1px solid #eee;border-radius:8px;padding:10px;"></textarea>
            <button id="saveNotesBtn" class="btn btn-primary" style="margin-top:10px; width:fit-content;">Salvar</button>
        </div>
    </div>
    <div class="window" id="win-gallery" style="width:560px;height:420px;display:none">
        <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">Fotos e Memórias</div><div class="win-actions"><label class="win-btn" for="photoUploadInput">Adicionar Foto</label><button class="win-btn" data-close>X</button></div></div>
        <div class="win-content">
            <input type="file" id="photoUploadInput" accept="image/*" multiple style="display:none" />
            <div class="gallery" id="gallery"></div>
        </div>
    </div>
    <div class="window" id="win-music" style="width:340px;height:240px;display:none">
        <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">Música</div><div class="win-actions"><button class="win-btn" data-close>X</button></div></div>
        <div class="win-content music-player">
            <label for="musicUploadInput" class="btn btn-primary">Adicionar Músicas</label>
            <input type="file" id="musicUploadInput" accept="audio/*" multiple style="display:none" />
            <p style="margin-top:15px;">Tocando no App:</p>
            <h3 id="song-title">-- Nenhuma --</h3>
            <div class="music-controls">
                <button id="prev-btn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button id="play-pause-btn"></button>
                <button id="next-btn"><svg viewBox="0 0 24 24"><path d="M16 6h2v12h-2zm-3.5 6l-8.5 6V6z"/></svg></button>
            </div>
        </div>
    </div>
    <div class="window" id="win-terminal" style="width:520px;height:340px;display:none">
      <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">Terminal Fofo</div><div class="win-actions"><button class="win-btn" data-close>X</button></div></div>
      <div class="win-content"><div class="term" id="term"><div>Bem-vindo ao <b>TheoShell 1.0</b> — digite <span class="prompt">ajuda</span>.</div><input id="termInput" autocomplete="off" /></div></div>
    </div>
    <div class="window" id="win-game" style="width:420px;height:320px;display:none">
      <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">Jogo: Colete Corações</div><div class="win-actions"><button class="win-btn" data-close>X</button></div></div>
      <div class="win-content"><p>Faça 10 pontos para um segredo 💖</p><div id="gameArea" style="position:relative;height:100%;background:var(--xp-sky);border-radius:12px;overflow:hidden"></div><div style="margin-top:8px">Pontuação: <b id="score">0</b> / 10</div></div>
    </div>
    <div class="window" id="win-achv" style="width:420px;height:300px;display:none">
      <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">Conquistas do Amor</div><div class="win-actions"><button class="win-btn" data-close>X</button></div></div>
      <div class="win-content achievements" id="achv"><div class="ach">🏅 Primeira risada</div><div class="ach">📸 Selfie da semana</div><div class="ach">🫶 Abraço de 10s</div></div>
    </div>
    <div class="window" id="win-paint" style="width:500px;height:400px;display:none"> <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">Desenho</div><div class="win-actions"><button class="win-btn" data-close>X</button></div></div> <div class="win-content"><div class="paint-toolbar"><div id="color-palette" class="color-palette"></div><button id="clear-canvas-btn" class="win-btn" style="margin-left:auto">Limpar</button></div><canvas id="paint-canvas"></canvas></div> </div>
    <div class="window" id="win-reminder" style="width:380px;height:260px;display:none"> <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">Lembrete</div><div class="win-actions"><button class="win-btn" data-close>X</button></div></div> <div class="win-content"><p id="reminder-text"></p></div> </div>
    <div class="window" id="win-calculator" style="width:320px;height:400px;display:none"> <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">Calculadora</div><div class="win-actions"><button class="win-btn" data-close>X</button></div></div> <div class="win-content"><div class="calculator"><div id="calc-display" class="calc-display">0</div></div></div> </div>
    <div class="window" id="win-settings" style="width:420px;height:320px;display:none"> <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">Configurações</div><div class="win-actions"><button class="win-btn" data-close>X</button></div></div> <div class="win-content settings-grid"><div class="settings-group"><h3>Tema de Cores</h3><div id="theme-options" class="options"></div></div><div class="settings-group"><h3>Papel de Parede</h3><div id="wallpaper-options" class="options"></div></div></div> </div>
    <div class="window" id="win-adventure" style="width:480px;height:360px;display:none">
      <div class="titlebar"><div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">Pequenas Aventuras</div><div class="win-actions"><button class="win-btn" data-close>X</button></div></div>
      <div class="win-content">
        <p id="adventure-text" class="adventure-text"></p>
        <div id="adventure-choices" class="adventure-choices"></div>
      </div>
    </div>
  </section>

  <audio id="startupSound" src="ini.mp3"></audio>
  <audio id="appMusicPlayer"></audio>
  <audio id="backgroundMusicPlayer"></audio>
  <audio id="sfxPlayer"></audio>
  
  <script>
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // --- SONS DO SISTEMA ---
    const sfx = { open: 'open.mp3', close: 'close.mp3', click: 'click.mp3' };
    const sfxPlayer = $('#sfxPlayer');
    function playSound(soundName) {
        if (!sfx[soundName]) return;
        sfxPlayer.src = sfx[soundName];
        sfxPlayer.play().catch(e => {});
    }

    // --- INICIALIZAÇÃO ---
    const appMusicPlayer = $('#appMusicPlayer');
    const backgroundMusicPlayer = $('#backgroundMusicPlayer');
    const muteBtn = $('#mute-btn');
    const soundOnIcon = `<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
    const soundOffIcon = `<svg viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>`;

    $('#initButton').addEventListener('click', () => {
      $('#pre-boot').style.display = 'none';
      $('#bootScreen').style.display = 'grid';
      sfxPlayer.volume = 0.5;
      appMusicPlayer.volume = 0.5;
      backgroundMusicPlayer.volume = 0.15; // Volume da música de fundo
      $('#bootVideo').play();
    });
    $('#bootVideo').addEventListener('ended', () => {
      $('#bootScreen').style.display = 'none';
      $('#login').style.display = 'grid';
      $('#startupSound').play();
    });
    $('#loginForm').addEventListener('submit', (e) => { e.preventDefault(); startSystem(); });
    
    function startSystem() {
      $('#login').style.display = 'none';
      $('#desktop').style.display = 'block';
      playNextBgTrack(); // Música de fundo começa após o login
      const isMuted = localStorage.getItem('theoos-bg-music-muted') === 'true';
      backgroundMusicPlayer.muted = isMuted;
      updateMuteButton();
      loadNotes();
      renderGallery();
      loadSettings();
    }

    // --- MÚSICA DE FUNDO E BOTÃO DE MUTE ---
    const backgroundPlaylist = ['musga_1.mp3', 'musga_2.mp3'];
    let currentBgTrackIndex = 0;
    function playNextBgTrack() {
        if (backgroundPlaylist.length === 0) return;
        backgroundMusicPlayer.src = backgroundPlaylist[currentBgTrackIndex];
        backgroundMusicPlayer.play();
        currentBgTrackIndex = (currentBgTrackIndex + 1) % backgroundPlaylist.length;
    }
    backgroundMusicPlayer.addEventListener('ended', playNextBgTrack);

    function updateMuteButton() { muteBtn.innerHTML = backgroundMusicPlayer.muted ? soundOffIcon : soundOnIcon; }
    muteBtn.addEventListener('click', () => {
        backgroundMusicPlayer.muted = !backgroundMusicPlayer.muted;
        localStorage.setItem('theoos-bg-music-muted', backgroundMusicPlayer.muted);
        updateMuteButton();
    });

    // --- LÓGICA GERAL DO DESKTOP ---
    setInterval(() => $('#clock').textContent = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }), 1000);
    const startMenu = $('#startMenu');
    $('#startBtn').addEventListener('click', (e) => { e.stopPropagation(); startMenu.style.display = 'block'; playSound('open'); });
    document.addEventListener('click', () => startMenu.style.display = 'none');

    let zTop = 10;
    function bringToFront(win) { $$('.window').forEach(w => w.classList.remove('focus')); win.classList.add('focus'); win.style.zIndex = ++zTop; }

    function openWin(sel) {
      const win = $(sel);
      if (!win) return;
      win.style.display = 'flex';
      bringToFront(win);
      playSound('open');
      if (sel === '#win-reminder') showRandomReminder();
      if (sel === '#win-paint') initPaint();
      if (sel === '#win-adventure') renderScene('start');
    }

    function closeWin(win) {
        win.style.display = 'none';
        playSound('close');
    }

    // --- GERENCIAMENTO DE JANELAS ---
    let drag = null;
    function startDrag(e) {
      if (e.target.closest('.win-actions, .dots')) return;
      const win = e.currentTarget.parentElement; bringToFront(win);
      const rect = win.getBoundingClientRect();
      drag = { win, offX: e.clientX - rect.left, offY: e.clientY - rect.top };
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', endDrag);
    }
    function onDrag(e) { if (!drag) return; win.style.left = `${e.clientX - drag.offX}px`; win.style.top = `${e.clientY - drag.offY}px`; }
    function endDrag() { if (!drag) return; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', endDrag); drag = null; }

    // --- APLICATIVOS (CRIAÇÃO DE ÍCONES E LÓGICA) ---
    const appData = [
      { name: 'Cartas', id: '#win-notes' }, { name: 'Fotos', id: '#win-gallery' },
      { name: 'Música', id: '#win-music' }, { name: 'Desenho', id: '#win-paint' },
      { name: 'Lembrete', id: '#win-reminder' }, { name: 'Calculadora', id: '#win-calculator' },
      { name: 'Terminal', id: '#win-terminal' }, { name: 'Conquistas', id: '#win-achv' },
      { name: 'Jogo', id: '#win-game' }, { name: 'Configurações', id: '#win-settings' },
      { name: 'Aventura', id: '#win-adventure' }
    ];
    const iconsContainer = $('.icons'), startList = $('.start-list');
    appData.forEach(app => {
        const iconHtml = `<div class="icon" data-open="${app.id}" title="${app.name}"><svg viewBox="0 0 24 24" fill="none">${{
            '#win-notes': '<rect x="3" y="4" width="18" height="16" rx="3" fill="#ffd3e2"/><path d="M4 7l8 6 8-6" stroke="#ff7aa5" stroke-width="1.6"/>',
            '#win-gallery': '<rect x="3" y="5" width="18" height="14" rx="3" fill="#bfe9ff"/><circle cx="9" cy="10" r="2" fill="#84c8ff"/><path d="M5 16l4-3 3 2 3-2 4 3" stroke="#3ba9ff" stroke-width="1.6"/>',
            '#win-music': '<circle cx="12" cy="12" r="8" fill="#ffd3e2"/><path d="M10 8.5v7l6-3.5z" fill="#ff7aa5"/>',
            '#win-paint': '<path d="M12 3a9 9 0 00-9 9c0 4.2 2.8 7.8 6.8 8.8l1.2.3V12h-3v-2h3V3z" fill="#ffe8a3"/><path d="M12 3a9 9 0 019 9c0 4.2-2.8 7.8-6.8 8.8l-1.2.3V12h3v-2h-3V3z" fill="#b3d4ff"/>',
            '#win-reminder': '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54z" fill="#ff8aa0"/>',
            '#win-calculator': '<rect x="4" y="3" width="16" height="18" rx="3" fill="#e6d9ff"/><rect x="7" y="8" width="10" height="2" rx="1" fill="#9c79ff"/><rect x="7" y="12" width="2" height="2" rx="1" fill="#9c79ff"/><rect x="11" y="12" width="2" height="2" rx="1" fill="#9c79ff"/>',
            '#win-settings': '<circle cx="12" cy="12" r="3" fill="#aaa"/><path d="M19.4 12.5a7.4 7.4 0 11-14.8 0 7.4 7.4 0 0114.8 0z" stroke="#aaa" stroke-width="1.8"/>',
            '#win-terminal': '<rect x="3" y="4" width="18" height="16" rx="3" fill="#e6d9ff"/><path d="M7 9l3 3-3 3" stroke="#9c79ff" stroke-width="1.6"/><path d="M12 15h5" stroke="#9c79ff" stroke-width="1.6"/>',
            '#win-achv': '<path d="M12 3l2.2 4.5 5 .7-3.6 3.6.9 5-4.5-2.4-4.5 2.4.9-5L4.8 8.2l5-.7z" fill="#ffe8a3"/>',
            '#win-game': '<rect x="2" y="6" width="20" height="12" rx="6" fill="#c7f4c2"/><circle cx="9" cy="12" r="1.8" fill="#77d173"/><rect x="14" y="10.2" width="1.4" height="3.6" rx=".7" fill="#77d173"/><rect x="12.6" y="11.4" width="3.6" height="1.4" rx=".7" fill="#77d173"/>',
            '#win-adventure': '<path d="M9 3l-1 2H4v13h16V5h-4l-1-2z" fill="#ffe8a3"/><path d="M4 10h16m-8 0v8m-3-3l3 3 3-3" stroke="#c7a14d" stroke-width="1.6" stroke-linecap="round"/>'
        }[app.id]}</svg><div class="badge">${app.name}</div></div>`;
        iconsContainer.innerHTML += iconHtml;
        startList.innerHTML += `<div class="start-item" data-open="${app.id}">${app.name}</div>`;
    });

    $$('.icon, .start-item').forEach(el => {
      const action = el.classList.contains('icon') ? 'dblclick' : 'click';
      el.addEventListener(action, (e) => {
        e.stopPropagation();
        playSound('click');
        openWin(el.dataset.open);
        if (action === 'click') startMenu.style.display = 'none';
      });
    });
    $$('.window').forEach(win => {
        $('.titlebar', win).addEventListener('mousedown', startDrag);
        win.addEventListener('mousedown', () => bringToFront(win));
        $('[data-close]', win).addEventListener('click', () => closeWin(win));
    });
    
    // --- LÓGICA ESPECÍFICA DOS APLICATIVOS ---

    // Cartas
    const notesArea = $('#notesArea');
    function saveNotes() { localStorage.setItem('theoos-notes', notesArea.value); alert('Carta salva! ❤️'); }
    function loadNotes() { notesArea.value = localStorage.getItem('theoos-notes') || 'Escreva algo fofo para o Theo aqui...'; }
    $('#saveNotesBtn')?.addEventListener('click', saveNotes);

    // Fotos com Legendas
    const photoUploadInput = $('#photoUploadInput'), galleryContainer = $('#gallery');
    let photos = JSON.parse(localStorage.getItem('theoos-photos')) || [];
    function savePhotos() { localStorage.setItem('theoos-photos', JSON.stringify(photos)); }
    function renderGallery() {
        galleryContainer.innerHTML = '';
        if (photos.length === 0) { galleryContainer.innerHTML = '<p style="text-align:center; color:#999;">Adicione fotos!</p>'; }
        photos.forEach(photo => { const fig = document.createElement('figure'); fig.innerHTML = `<img src="${photo.src}" alt="${photo.caption}"><figcaption>${photo.caption}</figcaption>`; galleryContainer.appendChild(fig); });
    }
    photoUploadInput?.addEventListener('change', (e) => {
        for (const file of e.target.files) {
            const caption = prompt(`Digite uma legenda para "${file.name}":`);
            if (caption === null) continue;
            const reader = new FileReader();
            reader.onload = (event) => { photos.push({ src: event.target.result, caption: caption }); savePhotos(); renderGallery(); };
            reader.readAsDataURL(file);
        }
    });

    // Player de Música
    const musicUploadInput = $('#musicUploadInput');
    const songTitle = $('#song-title'), playPauseBtn = $('#play-pause-btn');
    const prevBtn = $('#prev-btn'), nextBtn = $('#next-btn');
    const playIcon = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`, pauseIcon = `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
    let appPlaylist = []; let currentAppTrackIndex = 0;
    function loadAppTrack(index) {
        if (index < 0 || index >= appPlaylist.length) return;
        currentAppTrackIndex = index;
        appMusicPlayer.src = appPlaylist[index].url;
        songTitle.textContent = appPlaylist[index].name;
        appMusicPlayer.play();
    }
    function updatePlayPauseIcon() { playPauseBtn.innerHTML = appMusicPlayer.paused ? playIcon : pauseIcon; }
    playPauseBtn.addEventListener('click', () => { if (appPlaylist.length > 0) { appMusicPlayer.paused ? appMusicPlayer.play() : appMusicPlayer.pause(); }});
    nextBtn.addEventListener('click', () => { if (appPlaylist.length > 0) loadAppTrack((currentAppTrackIndex + 1) % appPlaylist.length); });
    prevBtn.addEventListener('click', () => { if (appPlaylist.length > 0) loadAppTrack((currentAppTrackIndex - 1 + appPlaylist.length) % appPlaylist.length); });
    appMusicPlayer.addEventListener('play', () => { backgroundMusicPlayer.pause(); updatePlayPauseIcon(); });
    appMusicPlayer.addEventListener('pause', () => { if(backgroundMusicPlayer.src && !backgroundMusicPlayer.muted) backgroundMusicPlayer.play(); updatePlayPauseIcon(); });
    appMusicPlayer.addEventListener('ended', () => { if (currentAppTrackIndex === appPlaylist.length - 1) { if(backgroundMusicPlayer.src && !backgroundMusicPlayer.muted) backgroundMusicPlayer.play(); songTitle.textContent = '-- Nenhuma --'; updatePlayPauseIcon(); } else { nextBtn.click(); }});
    musicUploadInput?.addEventListener('change', (e) => {
        const wasEmpty = appPlaylist.length === 0;
        for (const file of e.target.files) { appPlaylist.push({ name: file.name, url: URL.createObjectURL(file) }); }
        if (wasEmpty && appPlaylist.length > 0) { loadAppTrack(0); }
    });
    updatePlayPauseIcon();
    
    // Terminal
    const term = $('#term'), termInput = $('#termInput');
    const commands={ajuda:()=>print("Comandos: ajuda, oi, data, amor, limpar"),oi:()=>print("Oi, Theo! 💖"),data:()=>print(new Date().toLocaleString('pt-BR')),amor:()=>print("Amor = 100%."),limpar:()=>term.querySelectorAll('div:not(:first-child)').forEach(d=>d.remove())};
    function print(t){const l=document.createElement('div');l.innerHTML=t;term.insertBefore(l,termInput);term.scrollTop=term.scrollHeight}
    termInput?.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=termInput.value.trim().toLowerCase();print(`<span class="prompt">theo@amor:~$</span> ${v}`);termInput.value='';commands[v]?commands[v]():print('Comando não encontrado.')}});

    // Jogo dos Corações
    const gameArea=$('#gameArea'); let score=0;
    function spawnHeart(){const h=document.createElement('div');h.textContent='💗';h.style.cssText=`position:absolute;left:${Math.random()*(gameArea.clientWidth-24)}px;top:${Math.random()*(gameArea.clientHeight-24)}px;font-size:${Math.random()*24+18}px;user-select:none;cursor:pointer;`;h.addEventListener('click',()=>{score++;$('#score').textContent=score;h.remove();});gameArea.appendChild(h);setTimeout(()=>h.remove(),1800)}
    setInterval(()=>{if(gameArea && $('#win-game').style.display==='flex')spawnHeart()},600);

    // Lembrete do Dia
    const reminders = ["Lembrete: Você é meu lugar favorito. 💖", "Não se esqueça do quão incrível você é!", "Um abraço seu cura tudo. ✨", "Você tem o sorriso mais lindo.", "Sou sua fã número 1!"];
    function showRandomReminder() { $('#reminder-text').textContent = reminders[Math.floor(Math.random() * reminders.length)]; }

    // App de Desenho
    const paintCanvas = $('#paint-canvas'), colorPalette = $('#color-palette');
    let ctx, isDrawing = false, lastX = 0, lastY = 0;
    const colors = ['#3a3a3a', '#ff8aa0', '#ffd47a', '#9be69b', '#84c8ff', '#9c79ff'];
    function initPaint() {
      if (ctx) return;
      ctx = paintCanvas.getContext('2d');
      const rect = paintCanvas.getBoundingClientRect();
      paintCanvas.width = rect.width; paintCanvas.height = rect.height;
      ctx.lineCap = 'round'; ctx.lineWidth = 5; ctx.strokeStyle = colors[0];
      colors.forEach((c, i) => { const b = document.createElement('div'); b.className = 'color-box'; b.style.background = c; if (i === 0) b.classList.add('active'); b.addEventListener('click', () => { ctx.strokeStyle = c; $$('.color-box').forEach(x => x.classList.remove('active')); b.classList.add('active'); }); colorPalette.appendChild(b); });
      paintCanvas.addEventListener('mousedown', (e) => { isDrawing = true; [lastX, lastY] = [e.offsetX, e.offsetY]; });
      paintCanvas.addEventListener('mousemove', (e) => { if (!isDrawing) return; ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); [lastX, lastY] = [e.offsetX, e.offsetY]; });
      paintCanvas.addEventListener('mouseup', () => isDrawing = false);
      paintCanvas.addEventListener('mouseleave', () => isDrawing = false);
      $('#clear-canvas-btn')?.addEventListener('click', () => ctx.clearRect(0, 0, paintCanvas.width, paintCanvas.height));
    }

    // Calculadora
    const calcDisplay = $('#calc-display');
    const calcContainer = $('.calculator');
    'C,/,*,CE,7,8,9,-,4,5,6,+,1,2,3,=,0,.'.split(',').forEach(label => {
        const btn = document.createElement('button'); btn.textContent = label; btn.className = 'calc-btn';
        if ('/*-+'.includes(label)) btn.classList.add('op'); if (label === '=') btn.classList.add('eq');
        btn.addEventListener('click', () => {
            playSound('click');
            let current = calcDisplay.textContent === '0' || calcDisplay.textContent === 'Erro' ? '' : calcDisplay.textContent;
            if (label === 'C') { current = '0'; }
            else if (label === 'CE') { current = current.slice(0, -1) || '0'; }
            else if (label === '=') { try { current = String(eval(current.replace(/[^0-9.*/+-.]/g, ''))); } catch { current = 'Erro'; } }
            else { current += label; }
            calcDisplay.textContent = current;
        });
        calcContainer?.appendChild(btn);
    });

    // Configurações (Temas e Wallpapers)
    const root = document.documentElement, wallpaper = $('#wallpaper');
    const themes = {
        'Pastel Padrão': { '--xp-blue': '#b3d4ff', '--xp-pink': '#ffd3e2', '--titlebar-focus': 'linear-gradient(180deg, #ffd6e8, #ffc2dc)' },
        'Rosa Doce': { '--xp-blue': '#ffcde6', '--xp-pink': '#ffb3d9', '--titlebar-focus': 'linear-gradient(180deg, #e6d9ff, #d9c2ff)' }
    };
    const wallpapers = {
        'Verde e Azul': `radial-gradient(1200px 700px at 60% 110%, #b8f7c3 0%, #a8e9f0 55%, #c9d8ff 100%)`,
        'Amor Rosa': `url('wallpaper2.jpg')`
    };
    function applyTheme(name) { Object.entries(themes[name]).forEach(([k, v]) => root.style.setProperty(k, v)); localStorage.setItem('theoos-theme', name); updateActiveButtons('#theme-options', name); }
    function applyWallpaper(name) { wallpaper.style.backgroundImage = wallpapers[name]; localStorage.setItem('theoos-wallpaper', name); updateActiveButtons('#wallpaper-options', name); }
    function updateActiveButtons(id, active) { $$(`${id} button`).forEach(b => b.classList.toggle('active', b.textContent === active)); }
    function loadSettings() {
        applyTheme(localStorage.getItem('theoos-theme') || 'Pastel Padrão');
        applyWallpaper(localStorage.getItem('theoos-wallpaper') || 'Verde e Azul');
    }
    Object.keys(themes).forEach(name => { const btn = document.createElement('button'); btn.textContent = name; btn.onclick = () => applyTheme(name); $('#theme-options')?.appendChild(btn); });
    Object.keys(wallpapers).forEach(name => { const btn = document.createElement('button'); btn.textContent = name; btn.onclick = () => applyWallpaper(name); $('#wallpaper-options')?.appendChild(btn); });

    // Aventura (RPG de Texto)
    const story = {
        start: { text: "Você e Theo encontram uma clareira mágica. No centro, uma fonte sussurra melodias. À direita, uma trilha brilha com poeira de estrelas. O que fazer?", choices: [{ text: "Beber da fonte", next: "fonte" }, { text: "Seguir a trilha", next: "trilha" }] },
        fonte: { text: "Ao beberem a água, vocês começam a flutuar! No céu, uma nuvem em formato de coração acena.", choices: [{ text: "Flutuar até a nuvem", next: "nuvem" }, { text: "Tentar voltar ao chão", next: "chao" }] },
        trilha: { text: "A trilha leva a uma árvore gigante com uma porta com maçaneta de biscoito.", choices: [{ text: "Girar a maçaneta", next: "porta" }, { text: "Comer a maçaneta!", next: "comer_macaneta" }] },
        nuvem: { text: "A nuvem é de algodão-doce! É o piquenique mais fofo de todos. (Final Feliz ☁️)", choices: [{ text: "Recomeçar", next: "start" }] },
        chao: { text: "Vocês voltam ao chão e agora podem falar com animais. Um coelho os convida para um chá.", choices: [{ text: "Aceitar", next: "cha_coelho" }, { text: "Recusar", next: "start" }] },
        cha_coelho: { text: "A festa do chá é maravilhosa, com bolos de cenoura e risadas. (Final Amigável 🐰)", choices: [{ text: "Recomeçar", next: "start" }] },
        porta: { text: "A porta se abre para uma biblioteca aconchegante dentro da árvore. (Final Aconchegante 📚)", choices: [{ text: "Recomeçar", next: "start" }] },
        comer_macaneta: { text: "A maçaneta é deliciosa, mas a porta some! Oops. (Fim Engraçado 🍪)", choices: [{ text: "Recomeçar", next: "start" }] }
    };
    const adventureText = $('#adventure-text'), adventureChoices = $('#adventure-choices');
    function renderScene(sceneKey) {
        const scene = story[sceneKey]; if (!scene) return;
        adventureText.textContent = scene.text;
        adventureChoices.innerHTML = '';
        scene.choices.forEach(choice => {
            const button = document.createElement('button');
            button.className = 'btn btn-primary';
            button.textContent = choice.text;
            button.onclick = () => { playSound('click'); renderScene(choice.next); };
            adventureChoices.appendChild(button);
        });
    }

  </script>
</body>
</html>